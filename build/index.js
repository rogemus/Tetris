(()=>{CanvasRenderingContext2D.prototype.roundRect=function(o,e,t,i,r){return t<2*r&&(r=t/2),i<2*r&&(r=i/2),this.beginPath(),this.moveTo(o+r,e),this.arcTo(o+t,e,o+t,e+i,r),this.arcTo(o+t,e+i,o,e+i,r),this.arcTo(o,e+i,o,e,r),this.arcTo(o,e,o+t,e,r),this.closePath(),this};var u=o=>o==="L"?"R":"L";var a=["#26243a","#ec1c24","#f6921e","#eb008b","#fff7f8","#fff100","#a6a8ad","#00adee"];var d=[[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],[[0,1,0],[0,1,0],[1,1,0]],[[0,1,0],[0,1,0],[0,1,1]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[1,1,1],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]];var f=class{constructor(e,t,i){this.canvas=e;this.width=t;this.height=i;this.board=[];this.context=this.canvas.getContext("2d"),this.context.scale(20,20),this.createBoard(),this.drawBoard()}createBoard(){for(let e=0;e<this.height;e++)this.board.push(new Array(this.width).fill(0))}drawBlock(e,t,i){this.context.roundRect(e,t,1-.13,1-.13,.2),this.context.fillStyle=i,this.context.fill()}drawBoard(){this.context.fillStyle="#141020",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.board.forEach((e,t)=>{e.forEach((i,r)=>{this.drawBlock(r,t,a[i])})})}drawPlayer(e,t){e.shape.forEach((i,r)=>{i.forEach((s,l)=>{s>0&&this.drawBlock(l+t.x,r+t.y,a[s])})})}},p=f;var h="ROWS_REMOVED_EVENT",E=class extends p{constructor(e){super(document.getElementById("tetris"),12,20);this.player=e;this.dropCounter=0;this.dropInterval=750;this.lastTime=0;this.attachEvents(),this.start()}start(){let e=(t=0)=>{this.drawBoard(),this.drawPlayer(this.player.piece,this.player.pos);let i=t-this.lastTime;this.lastTime=t,this.dropCounter+=i;let r=this.dropInterval/this.player.speed.speedMultiplier;this.dropCounter>r&&this.playerDrop(),requestAnimationFrame(e)};e()}attachEvents(){document.addEventListener("keydown",e=>{switch(e.key){case"ArrowLeft":{this.playerMove(-1);break}case"ArrowRight":{this.playerMove(1);break}case"ArrowDown":{this.playerDrop();break}case"q":{this.playerRotate("L");break}case"e":{this.playerRotate("R");break}}})}isColliding(e){let t=e.piece.shape,i=e.pos;for(let r=0;r<t.length;r++)for(let s=0;s<t[r].length;s++)if(t[r][s]!==0&&(this.board[r+i.y]&&this.board[r+i.y][s+i.x])!==0)return!0;return!1}merge(e){e.piece.shape.forEach((i,r)=>{i.forEach((s,l)=>{s!==0&&(this.board[r+e.pos.y][l+e.pos.x]=s)})})}playerDrop(){this.player.drop(),this.dropCounter=0,this.isColliding(this.player)&&(this.player.revertDrop(),this.merge(this.player),this.sweep(),this.playerReset())}playerMove(e){this.player.move(e),this.isColliding(this.player)&&this.player.move(e*-1)}playerReset(){this.player.reset(),this.isColliding(this.player)&&console.log("end")}playerRotate(e){let t=1,i=this.player.pos;for(this.player.rotate(e);this.isColliding(this.player);)if(this.player.pos.x+=t,t=-(t+(t>0?1:-1)),t>this.player.piece.shape[0].length){this.player.rotate(u(e)),this.player.pos.x=i.x;return}}sweep(){let e=0,t=[...this.board];if(t=t.filter(i=>i.includes(0)),e=this.board.length-t.length,e>0){for(let r=0;r<e;r++)t.unshift(new Array(this.width).fill(0));let i=new CustomEvent(h,{detail:{removedCount:e}});document.dispatchEvent(i),this.board=t}}},y=E;var b=class{constructor(){this.pieces=d;this.id=this.getRandomIndex(0,6),this.shape=this.getRandomShape()}flip(e){let t;switch(e){case"R":{t=this.flipShape(this.shape.reverse());break}case"L":{t=this.flipShape(this.shape).reverse();break}}this.shape=t}colorPiece(e,t){return e.map(r=>r.map(s=>s*(t+1)))}flipShape(e){return e.map((t,i)=>e.map(r=>r[i]))}getRandomIndex(e,t){return Math.floor(Math.random()*(t-e))+e}getRandomShape(){let e=this.pieces[this.id];return this.colorPiece(e,this.id)}},n=b;var m="SCORE_UPDATE_EVENT",v="SPEED_UPDATE_EVENT",P=class{constructor(){this.nextPiece=new n;this.piece=new n;this.pos={x:4,y:0};this.score={pointsMultiplier:5,points:0,combo:1};this.speed={speedLevel:1,speedMultiplier:1};this.attachEvents()}drop(){this.pos.y++}move(e){this.pos.x+=e}reset(){this.pos={x:4,y:0},this.piece=this.nextPiece,this.nextPiece=new n}revertDrop(){this.pos.y--}rotate(e){this.piece.flip(e)}addScore(e){this.score.combo=e,this.score.points+=e*this.score.combo*this.score.pointsMultiplier}attachEvents(){document.addEventListener(h,this.handlePointsChange.bind(this))}handlePointsChange(e){this.addScore(e.detail.removedCount),this.speedUp();let t=new CustomEvent(m,{detail:{score:this.score}}),i=new CustomEvent(v,{detail:{speed:this.speed}});document.dispatchEvent(t),document.dispatchEvent(i)}speedUp(){this.speed.speedLevel<5&&(this.score.points>=20||this.score.points>=100||this.score.points>=300||this.score.points>=800)&&(this.score.pointsMultiplier+=2,this.speed.speedLevel+=1,this.speed.speedMultiplier+=.5)}},g=P;var x=class extends p{constructor(e){super(document.getElementById("nextMove"),4,4);this.player=e;this.drawPlayer(this.player.nextPiece,{x:0,y:0}),this.start()}start(){let e=()=>{this.drawBoard(),this.drawPlayer(this.player.nextPiece,{x:1,y:0}),requestAnimationFrame(e)};e()}},R=x;var w=class{constructor(e){this.selector=e;this.element=document.querySelector(this.selector),this.valueElement=this.element.querySelector(".widget-value"),this.contentElement=this.element.querySelector(".widget-content")}updateWidget(e){this.valueElement.innerHTML=e}},c=w;var S=class extends c{constructor(){super(".score");this.updateWidget("0"),this.attachEvents()}attachEvents(){document.addEventListener(m,this.handleUpdate.bind(this))}handleUpdate(e){this.updateWidget(e.detail.score.points)}},D=S;var T=class extends c{constructor(){super(".speed");this.updateWidget("1"),this.attachEvents()}attachEvents(){document.addEventListener(v,this.handleUpdate.bind(this))}handleUpdate(e){this.updateWidget(e.detail.speed.speedMultiplayer)}},C=T;var M=class{constructor(){this.player=new g;this.gameBoard=new y(this.player);this.nextMoveBoard=new R(this.player);this.scoreWidget=new D;this.speedWidget=new C}start(){this.gameBoard.start()}},B=M;var W=new B;W.start();})();
